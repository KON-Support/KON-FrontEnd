<div class="container-fluid pt-3 px-3">
  <a [routerLink]="['/chamados']" class="text-decoration-none text-dark"
    ><i class="bi bi-arrow-left-short"></i>Voltar</a
  >
</div>
<section class="container-fluid d-flex flex-row p-3">
  <main class="d-flex flex-column flex-nowrap p-3 w-75">
    <div class="p-3 mb-3 rounded-2 border border-1" style="min-height: 160px">
      <p class="badge bg-dark fw-bold mx-1">
        {{ chamado?.categoria?.nmCategoria || chamado?.categoria }}
      </p>
      <p class="badge bg-primary fw-bold mx-1">
        {{ chamado?.status }}
      </p>
      <p class="fw-bold">{{ chamado?.dsTitulo }}</p>
      <p class="text-muted">{{ chamado?.dsDescricao }}</p>
      <p>Anexo <br /></p>
      <div *ngIf="chamado?.anexo?.cdAnexo" class="mt-2">
        <button
          class="btn btn-sm btn-link p-0 text-decoration-none"
          (click)="downloadAnexo(chamado?.anexo?.cdAnexo, chamado?.anexo?.nmArquivo)"
        >
          <i class="bi bi-download me-1"></i>Baixar Anexo
        </button>
      </div>
    </div>
    <div class="d-flex flex-column flex-nowrap p-3 rounded-2 border border-1">
      <p>Conversação</p>
      @if (comentarios.length > 0) { @for (comentario of comentarios; track $index) {
      <div [ngClass]="'rounded-2 mb-3 p-3 border border-1 border-dark '">
        <p class="text-start">{{ comentario?.dtCriacao }} | {{ comentario?.hrCriacao }}</p>
        <p>{{ comentario?.dsConteudo }}</p>
        @if (comentarioHasAnexo(comentario)) {
        <button
          class="btn btn-sm btn-link p-0 text-decoration-none"
          (click)="downloadAnexo(getAnexoCd(comentario), getAnexoName(comentario))"
        >
          <i class="bi bi-download me-1"></i>Baixar anexo
        </button>
        }
      </div>
      } }
      <p *ngIf="comentarios.length === 0" class="text-muted">Nenhuma conversa ainda...</p>
      <hr />
      <p>Nova mensagem</p>
      @if (isChamadoFechadoOuResolvido()) {
      <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Chamado fechado ou resolvido. Não é possível adicionar comentários.
      </div>
      } @else {
      <textarea
        [(ngModel)]="novoConteudo"
        class="rounded-2 border border-1 border-dark mb-3 p-2"
        style="min-height: 100px"
        placeholder="Digite seu comentário aqui..."
      ></textarea>
      <div class="mb-4">
        <label for="anexo" class="form-label fw-medium">
          Anexar Arquivo
          <span class="badge bg-light text-muted ms-2">Opcional</span>
        </label>
        <input
          type="file"
          id="anexo"
          class="form-control"
          (change)="onFileSelected($event)"
          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
          [disabled]="isChamadoFechadoOuResolvido()"
        />
        <div
          *ngIf="arquivoSelecionado"
          class="mt-2 p-2 bg-light rounded d-flex align-items-center justify-content-between"
        >
          <span class="text-success">
            <i class="bi bi-file-earmark-check me-1"></i>
            {{ arquivoSelecionado.name }}
          </span>
          <small class="text-muted">{{ formatFileSize(arquivoSelecionado.size || 0) }}</small>
        </div>
      </div>
      <button
        (click)="enviarComentario()"
        [disabled]="enviando || !novoConteudo.trim() || isChamadoFechadoOuResolvido()"
        class="btn btn-outline-dark rounded-2 w-25 align-start mb-3"
      >
        {{ enviando ? 'Enviando...' : 'Enviar' }}
      </button>
      }
    </div>
  </main>
  <aside class="d-flex flex-column flex-nowrap p-3 w-25">
    <div class="p-3 mb-3 rounded-2 border border-1" style="min-height: 160px">
      <p>Status</p>
      <select
        class="form-select rounded-2 border border-1 border-dark px-3"
        [(ngModel)]="selectedStatus"
        (change)="onStatusChange()"
        [disabled]="!isAgente() || !chamado?.responsavel"
      >
        @for (st of getStatusesDisponiveis(); track st) {
        <option [ngValue]="st">{{ st }}</option>
        }
      </select>
      @if (!isAgente()) {
      <small class="text-muted">Somente agentes podem alterar o status</small>
      } @if (isAgente() && !chamado?.responsavel) {
      <button
        class="btn btn-outline-success mt-3"
        (click)="aceitarChamado()"
        [disabled]="atribuindo"
      >
        {{ atribuindo ? 'Atribuindo...' : 'Aceitar' }}
      </button>
      }
    </div>
    <div class="p-3 mb-3 rounded-2 border border-1">
      <p class="fw-light"><strong>Detalhes</strong></p>
      <p class="fw-light">
        <i class="bi bi-person"></i>
        Solicitante<br /><strong>{{ chamado?.solicitante?.nmUsuario }}</strong>
      </p>
      <p class="fw-light">
        <i class="bi bi-person"></i>
        Atribuído a<br /><strong>{{ chamado?.responsavel?.nmUsuario }}</strong>
      </p>
      <p class="fw-light">
        <i class="bi bi-tag me-1"></i>
        Categoria<br /><strong>{{ chamado?.categoria?.nmCategoria }}</strong>
      </p>
      <p class="fw-light">
        <i class="bi bi-calendar"></i>
        Criado em<br /><strong>{{ chamado?.dtCriacao }}</strong>
      </p>
      <p class="fw-light">
        <i class="bi bi-stopwatch"></i>
        Vencimento em<br /><strong>{{ chamado?.dtVencimento }}</strong>
      </p>
    </div>
  </aside>
</section>
